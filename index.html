<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="tooltips.css">
</head>

<body class="mixpanel-platform-body">

<div id="wrapper">
<div id="editor_wrapper">
<h1>Custom Query console</h1>

    <div id="editor">var result = {};

var scan = function(event, user) {
    // Count up all events that start with a certain letter
    if (event.name.toLowerCase().startsWith(params.first_letter.toLowerCase())) {
        result[event.name] = result[event.name] || 0;
        result[event.name] += 1;
    }
};
</div> <!-- weird formatting required for default code to look good -->

    <div id="controls">
        <table id="params_table">
            <tr>
                <th>
                    Dates to query: <a href="#" data-tooltip="This controls the `from_date` and `to_date` api parameters. We will only read data between these dates (inclusive)"><img src="question_mark.png" class="tooltip_questionmark" /></a>
                </th>
                <td><div id="dates"></div></td>
            </tr>
            <tr>
                <th>Days to analyze at once: <a href="#" data-tooltip="This controls the `window_size` api param. Use this to control how the query gets split up. For example, for a weekly uniques query, the smallest you can split up the query is into 7 days at a time - so you would pick 7."><img src="question_mark.png" class="tooltip_questionmark" /></th>
                <td><div id="window_size"></div></td>
            </tr>
                <th>Script params: <a href="#" data-tooltip="This is a global variable `params` that will be available to your script. This lets your scripts be flexible. For example, if you were writing Segmentation, you might add an 'event_name' parameter and filter for `if (event.name == params.event_name)` to your script."><img src="question_mark.png" class="tooltip_questionmark" /></th>
                <td><input type="text" value='{"first_letter": "v"}' id="script_params" /></td>
            <tr>
            </tr>
        </table>
        <button id="run_button">Run query</button>
    </div>
</div>

<br />

<div id="output"></div>
</div>
</div>

<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/textmate");
    editor.getSession().setMode("ace/mode/javascript");
    editor.setOptions({
        maxLines: 40
    });

    $("#dates").MPDatepicker();

    $("#window_size").MPSelect({
        items: _.map(
            _.range(1, 32),
            function(i) {
                return {'value': i, 'label': i.toString() };
            }
        )
    });

    function date_to_string(d) {
        return d.toISOString().split('T')[0];
    }

    function set_output(formatted) {
        $("#output").html(
            $("<pre>").html(formatted)
        );
    }

    $("#run_button").on('click', function() {
        // Show spinner while running query
        $("#output").html(
            $("<div class='spinner_wrapper'>").append(
                $("<img src='ajax-loader-big.gif' />")
            )
        );
        $("#output").css('visibility', 'visible');

        // Make query
        var dates = $("#dates").val();
        var params = {
            "from_date": date_to_string(dates.from),
            "to_date": date_to_string(dates.to),
            "window_size": $("#window_size").val(),
            "params": $("#script_params").val(),
            "script": editor.getValue()
        };
        MP.api.query("/api/2.0/custom_query", params)
            .done(function(resp) {
                var stringified = JSON.stringify(resp.results, undefined, 2);
                set_output(stringified);
            })
            .fail(function($xhr) {
                // linter errors come as text
                var error = $xhr.request.responseJSON.error;
                try {
                    // runtime errors come as a json blob
                    error = JSON.parse(error).error;
                } catch (err) {}
                set_output(error);
            });
    });
</script>
</body>
</html>
